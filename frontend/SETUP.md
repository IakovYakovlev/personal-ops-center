# Настройка и запуск системы аутентификации

## Предварительные требования

- Node.js 18+
- NestJS сервер (identity-service) запущен на `http://localhost:3001`

## Установка зависимостей

```bash
cd frontend
npm install
```

## Конфигурация

### 1. Создать `.env.local` файл

```bash
NEXT_PUBLIC_API_URL=http://localhost:3001
```

**Примечание**: Если ваш сервер запущен на другом адресе, измените URL.

## Запуск

### Разработка

```bash
npm run dev
```

Приложение будет доступно на `http://localhost:3000`

### Продакшн

```bash
npm run build
npm run start
```

## Тестирование системы аутентификации

### 1. Перейти на главную страницу

```
http://localhost:3000
```

Вы должны быть перенаправлены на `/login`

### 2. Зарегистрироваться (если это первый раз)

```
http://localhost:3000/register
```

- Введите email
- Проверьте email на письмо с ссылкой верификации
- Нажмите на ссылку в письме

### 3. Залогиниться

```
http://localhost:3000/login
```

- Введите email и пароль (выслан на почту при регистрации)
- После успешного логина вы будете на главной странице

### 4. Проверить время жизни JWT

- JWT действует 15 минут
- Если закрыть браузер и открыть снова через 15+ минут, вы будете перенаправлены на логин

### 5. Логаут

На главной странице нажмите кнопку "Logout"

## Структура потока аутентификации

```
Пользователь запрашивает защищенный маршрут
    ↓
Middleware проверяет наличие JWT в cookies
    ↓
❌ JWT отсутствует → Редирект на /login
    ↓
✅ JWT есть → Проверка валидности на сервере
    ↓
❌ JWT невалиден/истек → Удаление cookies, редирект на /login
    ↓
✅ JWT валиден → Доступ к защищенному маршруту
```

## Файлы конфигурации

### middleware.ts

- Проверяет JWT на каждый запрос
- Перенаправляет на логин при отсутствии токена
- Удаляет cookies при истечении токена

### lib/auth.ts

- Управление cookies (сохранение, получение, удаление)
- Проверка истечения токена

### lib/api-client.ts

- API клиент для запросов к серверу
- Функции: login, logout, register, getCurrentUser

### app/actions/auth.ts и register.ts

- Server Actions для безопасной обработки логина/регистрации
- Сохранение JWT на сервере

## Режим разработки (Debug)

Чтобы проверить работу middleware в режиме разработки:

1. Откройте DevTools → Application → Cookies
2. Посмотрите cookie `auth_token` после логина
3. Попытайтесь вручную удалить cookie
4. Обновите страницу - вы должны быть перенаправлены на логин

## Возможные проблемы

### CORS ошибки

Убедитесь, что:

- NestJS сервер запущен на `http://localhost:3001`
- В `package.json` указан правильный URL в `NEXT_PUBLIC_API_URL`

### JWT токен не сохраняется

- Проверьте, что сервер возвращает `{ accessToken: "..." }` при логине
- Убедитесь, что cookies включены в браузере

### Бесконечный редирект на логин

- Проверьте, что сервер доступен
- Убедитесь, что JWT валиден на сервере

## Отключение аутентификации для конкретных маршрутов

Чтобы добавить公开 маршрут, отредактируйте `middleware.ts`:

```typescript
const PUBLIC_ROUTES = [
  '/login',
  '/register',
  '/verify-registration',
  '/forgot-password',
  '/api', // Добавьте новый публичный маршрут
];
```
